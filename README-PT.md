# Spotipy MCP Server

Servidor MCP (Model Context Protocol) com integra√ß√£o Spotipy para controle de m√∫sica via Spotify.

## üöÄ Funcionalidades

- ‚úÖ Controle de playback (play, pause, next, previous)
- ‚úÖ Ajuste de volume
- ‚úÖ Busca de m√∫sicas
- ‚úÖ Obter m√∫sica atual
- ‚úÖ Gerenciar playlists
- ‚úÖ API REST completa
- ‚úÖ Documenta√ß√£o autom√°tica (Swagger)
- ‚úÖ Integra√ß√£o MCP completa com tools e resources

## üìã Pr√©-requisitos

- Python 3.12+
- Conta no Spotify Developer
- Aplica√ß√£o registrada no Spotify Developer Dashboard

## üõ†Ô∏è Instala√ß√£o

1. **Clone o reposit√≥rio:**

```bash
git clone <seu-repositorio>
cd mcp-server
```

2. **Instale as depend√™ncias:**

```bash
make install
```

3. **Configure as vari√°veis de ambiente:**

```bash
cp env.example .env
```

Edite o arquivo `.env` com suas credenciais do Spotify:

```env
SPOTIFY_CLIENT_ID=seu_client_id_aqui
SPOTIFY_CLIENT_SECRET=seu_client_secret_aqui
SPOTIFY_REDIRECT_URI=http://localhost:8888/callback
```

## üéµ Configura√ß√£o do Spotify

1. Acesse [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
2. Crie uma nova aplica√ß√£o
3. Copie o `Client ID` e `Client Secret`
4. Adicione `http://localhost:8888/callback` nas URLs de redirecionamento
5. **Importante:** Configure os seguintes escopos na sua aplica√ß√£o:
   - `user-read-playback-state` - Ler estado de reprodu√ß√£o
   - `user-modify-playback-state` - Controlar reprodu√ß√£o
   - `user-read-currently-playing` - M√∫sica atual
   - `playlist-read-private` - Playlists privadas
   - `user-library-read` - Biblioteca do usu√°rio
   - `user-top-read` - Top artistas e m√∫sicas
   - `user-read-recently-played` - M√∫sicas recentes
   - `user-follow-read` - Artistas seguidos
   - `user-read-email` - Email do usu√°rio
   - `user-read-private` - Informa√ß√µes privadas

## üöÄ Uso

### Iniciar o servidor:

```bash
make dev
```

O servidor estar√° dispon√≠vel em:

- **API**: http://localhost:8000
- **Documenta√ß√£o**: http://localhost:8000/docs
- **Health Check**: http://localhost:8000/health

## üõ†Ô∏è **Guia de Desenvolvimento**

### üîÑ **Comandos Essenciais**

```bash
# Restart completo do servidor
pkill -f "python.*mcp-server" && sleep 2 && make dev

# Kill portas MCP (OBRIGAT√ìRIO antes de run-inspector)
lsof -ti:6274 | xargs kill -9 && lsof -ti:6277 | xargs kill -9

# Verificar portas em uso
lsof -i:6274 && lsof -i:6277
```

### ‚ö†Ô∏è **IMPORTANTE: Sempre Kill as Portas!**

**ANTES de executar `make run-inspector`, SEMPRE execute:**

```bash
# Kill portas MCP (OBRIGAT√ìRIO)
lsof -ti:6274 | xargs kill -9 && lsof -ti:6277 | xargs kill -9
```

**Por que isso √© necess√°rio?**

- O MCP Inspector usa as portas 6274 (UI) e 6277 (Proxy)
- Se as portas estiverem ocupadas, o Inspector n√£o consegue iniciar
- Processos anteriores podem ter deixado as portas em uso

### üéØ **Fluxo de Desenvolvimento**

1. **Ap√≥s Modificar o C√≥digo:**

```bash
pkill -f "python.*mcp-server" && sleep 2 && make dev
```

2. **Para Testar com MCP Inspector:**

```bash
lsof -ti:6274 | xargs kill -9 && lsof -ti:6277 | xargs kill -9
make run-inspector
```

### Comandos dispon√≠veis:

```bash
make dev              # Iniciar servidor de desenvolvimento
make install          # Instalar depend√™ncias
make clean            # Limpar arquivos tempor√°rios
make test             # Executar testes
make lint             # Verificar qualidade do c√≥digo
make format           # Formatar c√≥digo
make run-inspector    # Executar MCP Inspector
make help             # Mostrar ajuda
```

## üéµ **Funcionalidades MCP**

### **Tools Dispon√≠veis:**

- `play_music` - Reproduzir m√∫sica
- `search_tracks` - Buscar m√∫sicas
- `get_current_track` - M√∫sica atual
- `get_playlists` - Listar playlists
- `get_recommendations` - Recomenda√ß√µes
- `get_user_profile` - Perfil do usu√°rio
- `get_devices` - Dispositivos dispon√≠veis
- `toggle_shuffle` - Alternar shuffle
- `toggle_repeat` - Alternar repeat
- `get_queue` - Fila de reprodu√ß√£o
- `get_genres` - G√™neros musicais
- `get_audio_features` - Caracter√≠sticas da m√∫sica

### **Recursos Dispon√≠veis:**

- `spotify://playback/current` - Reprodu√ß√£o atual
- `spotify://playlists` - Playlists do usu√°rio
- `spotify://devices` - Dispositivos
- `spotify://genres` - G√™neros
- `spotify://profile` - Perfil do usu√°rio
- `spotify://playback/queue` - Fila de reprodu√ß√£o

### **Templates de Recursos:**

- `spotify://playlist/{playlist_id}` - Playlist espec√≠fica
- `spotify://track/{track_id}` - M√∫sica espec√≠fica
- `spotify://artist/{artist_id}` - Artista espec√≠fico
- `spotify://album/{album_id}` - √Ålbum espec√≠fico
- `spotify://search/{query}` - Resultados de busca

## üìö API Endpoints

### Autentica√ß√£o

- `POST /auth` - Autenticar com Spotify
- `POST /auth/reauth` - Reautenticar com credenciais configuradas

### Playback

- `GET /current-track` - Obter m√∫sica atual
- `POST /play` - Tocar m√∫sica
- `POST /pause` - Pausar m√∫sica
- `POST /next` - Pr√≥xima m√∫sica
- `POST /previous` - M√∫sica anterior
- `POST /volume/{volume}` - Ajustar volume (0-100)
- `POST /seek/{position_ms}` - Pular para posi√ß√£o espec√≠fica
- `POST /shuffle` - Alternar modo shuffle
- `POST /repeat` - Alternar modo repeat

### Playlists e √Ålbuns

- `GET /playlists` - Obter playlists do usu√°rio
- `GET /playlist/{playlist_id}` - Obter m√∫sicas de uma playlist
- `GET /albums` - Obter √°lbuns salvos do usu√°rio
- `GET /tracks` - Obter m√∫sicas salvas do usu√°rio

### Artistas e Top Tracks

- `GET /artists` - Obter artistas favoritos do usu√°rio
- `GET /tracks/top` - Obter m√∫sicas mais tocadas

### Fila de Reprodu√ß√£o

- `GET /queue` - Obter fila de reprodu√ß√£o atual
- `POST /queue/add` - Adicionar m√∫sica √† fila

### Dispositivos

- `GET /devices` - Obter dispositivos dispon√≠veis
- `POST /devices/{device_id}/transfer` - Transferir playback

### Busca e Recomenda√ß√µes

- `GET /search/{query}` - Buscar m√∫sicas
- `GET /recommendations` - Obter recomenda√ß√µes personalizadas
- `GET /genres` - Obter g√™neros musicais dispon√≠veis

### Usu√°rio e An√°lise

- `GET /user/profile` - Obter perfil do usu√°rio
- `GET /audio-features/{track_id}` - Obter caracter√≠sticas de √°udio

### Sistema

- `GET /` - Status do servidor
- `GET /health` - Verifica√ß√£o de sa√∫de

## üîß Exemplos de Uso

### Tocar uma m√∫sica espec√≠fica:

```bash
curl -X POST "http://localhost:8000/play" \
  -H "Content-Type: application/json" \
  -d '{"track_uri": "spotify:track:4iV5W9uYEdYUVa79Axb7Rh"}'
```

### Buscar m√∫sicas:

```bash
curl "http://localhost:8000/search/bohemian%20rhapsody?limit=5"
```

### Ajustar volume:

```bash
curl -X POST "http://localhost:8000/volume/50"
```

### Obter m√∫sica atual:

```bash
curl "http://localhost:8000/current-track"
```

### Obter playlists do usu√°rio:

```bash
curl "http://localhost:8000/playlists"
```

### Obter m√∫sicas de uma playlist espec√≠fica:

```bash
curl "http://localhost:8000/playlist/37i9dQZF1DXcBWIGoYBM5M"
```

### Obter m√∫sicas salvas:

```bash
curl "http://localhost:8000/tracks"
```

### Obter artistas favoritos:

```bash
curl "http://localhost:8000/artists"
```

### Obter recomenda√ß√µes baseadas em artistas:

```bash
curl "http://localhost:8000/recommendations?seed_artists=4gzpq5DPGxSnKTe4SA8HAU&limit=10"
```

### Alternar shuffle:

```bash
curl -X POST "http://localhost:8000/shuffle"
```

### Adicionar m√∫sica √† fila:

```bash
curl -X POST "http://localhost:8000/queue/add?track_uri=spotify:track:4iV5W9uYEdYUVa79Axb7Rh"
```

### Obter dispositivos dispon√≠veis:

```bash
curl "http://localhost:8000/devices"
```

### Pular para posi√ß√£o espec√≠fica (30 segundos):

```bash
curl -X POST "http://localhost:8000/seek/30000"
```

### Reautenticar com Spotify:

```bash
curl -X POST "http://localhost:8000/auth/reauth"
```

## üß™ Testes

### üìä **Status dos Testes**

‚úÖ **60 testes PASSANDO** | ‚è±Ô∏è **~0.38s** | üîß **100% Funcional**

### üöÄ **Executar Testes**

```bash
# Executar todos os testes (recomendado)
make test-pytest

# Ou usar pytest diretamente
python -m pytest tests/ -v --tb=short --color=yes
```

### üìã **Cobertura de Testes**

#### üîß **Testes de Tools MCP (36 testes)**

- ‚úÖ Controle de playback (`play_music`, `pause_music`, `next_track`, `previous_track`)
- ‚úÖ Gerenciamento de volume (`set_volume`)
- ‚úÖ Busca e descoberta (`search_tracks`, `search_artists`, `search_albums`, `search_playlists`)
- ‚úÖ Playlists e √°lbuns (`get_playlists`, `get_playlist_tracks`, `get_album_tracks`)
- ‚úÖ Perfil e prefer√™ncias (`get_user_profile`, `get_top_tracks`, `get_top_artists`)
- ‚úÖ Biblioteca pessoal (`get_saved_tracks`, `get_saved_albums`, `get_followed_artists`)
- ‚úÖ Dispositivos e fila (`get_devices`, `get_queue`, `add_to_queue`)
- ‚úÖ Recomenda√ß√µes (`get_recommendations`, `get_genres`, `get_audio_features`)
- ‚úÖ Navega√ß√£o (`skip_to_next`, `skip_to_previous`, `seek_to_position`)
- ‚úÖ Hist√≥rico (`get_recently_played`)
- ‚úÖ Artistas relacionados (`get_related_artists`, `get_artist_top_tracks`, `get_artist_albums`)

#### üí¨ **Testes de Prompts MCP (6 testes)**

- ‚úÖ `spotify_assistant` - Assistente musical inteligente
- ‚úÖ `spotify_usage_guide` - Guia de uso das funcionalidades
- ‚úÖ `spotify_troubleshooting` - Solu√ß√£o de problemas

#### üìö **Testes de Resources MCP (12 testes)**

- ‚úÖ `spotify://playback/current` - Estado atual de reprodu√ß√£o
- ‚úÖ `spotify://playlists/user` - Playlists do usu√°rio
- ‚úÖ `spotify://devices/available` - Dispositivos dispon√≠veis
- ‚úÖ `spotify://genres/available` - G√™neros musicais
- ‚úÖ `spotify://user/profile` - Perfil do usu√°rio
- ‚úÖ `spotify://playback/queue` - Fila de reprodu√ß√£o
- ‚úÖ `spotify://user/top-tracks` - Top m√∫sicas
- ‚úÖ `spotify://user/top-artists` - Top artistas
- ‚úÖ `spotify://user/recently-played` - Reprodu√ß√µes recentes
- ‚úÖ `spotify://user/saved-tracks` - M√∫sicas salvas
- ‚úÖ `spotify://user/saved-albums` - √Ålbuns salvos
- ‚úÖ `spotify://user/followed-artists` - Artistas seguidos

#### üîß **Testes de Funcionalidade (3 testes)**

- ‚úÖ Estrutura correta das tools
- ‚úÖ Descri√ß√µes v√°lidas em todas as tools
- ‚úÖ Tratamento de erros implementado

#### üìä **Testes de Valida√ß√£o (2 testes)**

- ‚úÖ Valida√ß√£o de requisi√ß√µes de volume
- ‚úÖ Valida√ß√£o de requisi√ß√µes de busca

#### üîó **Teste de Integra√ß√£o (1 teste)**

- ‚úÖ Completude do servidor (tools, prompts, resources)

### üéØ **Comandos de Teste Dispon√≠veis**

```bash
# Executar todos os testes
make test-pytest           # Usando pytest (recomendado)

# Testes espec√≠ficos (futuros)
make test-tools            # Testes de tools apenas
make test-prompts          # Testes de prompts apenas
make test-resources        # Testes de resources apenas
make test-integration      # Testes de integra√ß√£o apenas
make test-coverage         # Verificar cobertura

# Teste com sa√≠da detalhada
python -m pytest tests/ -v -s --tb=long
```

### üìà **Resultados dos √öltimos Testes**

```
===================================== test session starts =====================================
collected 60 items

TestMCPServerBasics ‚úÖ (4/4)
TestMCPTools ‚úÖ (36/36)
TestMCPPrompts ‚úÖ (6/6)
TestMCPResources ‚úÖ (12/12)
TestToolFunctionality ‚úÖ (2/2)
TestErrorHandling ‚úÖ (1/1)
TestDataValidation ‚úÖ (2/2)
TestIntegration ‚úÖ (1/1)

===================================== 60 passed in 0.38s ======================================
```

### üîç **Estrutura dos Testes**

```
tests/
‚îú‚îÄ‚îÄ test_main.py          # Todos os testes do servidor MCP
‚îú‚îÄ‚îÄ __init__.py           # Inicializa√ß√£o do m√≥dulo
‚îî‚îÄ‚îÄ README.md            # Documenta√ß√£o dos testes
```

### üß™ **Como Adicionar Novos Testes**

1. **Para nova tool:**

```python
@pytest.mark.asyncio
async def test_nova_tool_exists(self):
    """Testa se a nova tool existe"""
    tools = await app.get_tools()
    assert 'nova_tool' in tools
```

2. **Para novo resource:**

```python
@pytest.mark.asyncio
async def test_novo_resource_exists(self):
    """Testa se o novo resource existe"""
    resources = await app.get_resources()
    assert 'spotify://novo/resource' in resources
```

### ‚ö†Ô∏è **Importante para Testes**

- **SEMPRE** execute os testes ap√≥s modificar o c√≥digo
- Use `make test-pytest` para execu√ß√£o r√°pida e confi√°vel
- Testes n√£o requerem autentica√ß√£o real do Spotify
- Testes focam na estrutura e disponibilidade das funcionalidades

## üîç Linting e Formata√ß√£o

```bash
make lint    # Verificar qualidade do c√≥digo
make format  # Formatar c√≥digo automaticamente
```

## üìù Estrutura do Projeto

```
mcp-server/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ mcp-server.py    # Servidor MCP principal
‚îÇ   ‚îú‚îÄ‚îÄ service.py       # L√≥gica do Spotify
‚îÇ   ‚îú‚îÄ‚îÄ server.py        # API FastAPI
‚îÇ   ‚îî‚îÄ‚îÄ config.py        # Configura√ß√µes
‚îú‚îÄ‚îÄ tests/               # Testes
‚îú‚îÄ‚îÄ makefile             # Comandos de desenvolvimento
‚îú‚îÄ‚îÄ pyproject.toml       # Configura√ß√µes do projeto

‚îú‚îÄ‚îÄ env.example          # Exemplo de vari√°veis de ambiente
‚îî‚îÄ‚îÄ README.md           # Este arquivo
```

## ‚ö†Ô∏è **Problemas Comuns**

### **Erro: "PORT IS IN USE"**

```bash
# Solu√ß√£o r√°pida
lsof -ti:6274 | xargs kill -9
lsof -ti:6277 | xargs kill -9
```

### **Erro: "ModuleNotFoundError"**

```bash
# Reinstalar depend√™ncias
make install
```

### **Servidor n√£o responde**

```bash
# Restart completo
pkill -f "python.*mcp-server" && sleep 2 && make dev
```

### **Erro 403 - Permiss√£o Insuficiente**

Se voc√™ receber erro 403 com mensagem "Insufficient client scope":

1. Verifique se todos os escopos necess√°rios est√£o configurados
2. Reautentique com o Spotify usando o endpoint `/auth`
3. Certifique-se de que aceitou todas as permiss√µes solicitadas

### **Endpoints que Requerem Permiss√µes Espec√≠ficas**

- `/artists` e `/tracks/top` - Requerem `user-top-read`
- `/recommendations` - Requer pelo menos um seed v√°lido
- `/user/profile` - Requer `user-read-email` e `user-read-private`

### **Problemas Conhecidos**

- **Recomenda√ß√µes (404)**: A API de recomenda√ß√µes pode retornar 404 em alguns casos. Isso pode ser devido a:
  - Problemas tempor√°rios da API do Spotify
  - Seeds inv√°lidos ou n√£o encontrados
  - Problemas de autentica√ß√£o
- **Solu√ß√£o**: Use o endpoint `/auth/reauth` para reautenticar se necess√°rio

## üîß **Dicas Importantes**

1. **SEMPRE** restart o servidor ap√≥s modificar `mcp-server.py`
2. **SEMPRE** kill as portas antes de executar o Inspector (6274 e 6277)
3. **SEMPRE** verifique se as portas est√£o livres antes de executar `make run-inspector`
4. **Verifique os logs** para identificar problemas
5. **Use `make dev`** para desenvolvimento local
6. **Mantenha o `.env`** configurado corretamente

## ü§ù Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo `LICENSE` para mais detalhes.

## üÜò Suporte

Se voc√™ encontrar algum problema ou tiver d√∫vidas:

1. Verifique se as credenciais do Spotify est√£o corretas
2. Certifique-se de que o Spotify est√° rodando em algum dispositivo
3. Verifique os logs do servidor para mais detalhes
4. Abra uma issue no reposit√≥rio

## üîó Links √öteis

- [Spotipy Documentation](https://spotipy.readthedocs.io/)
- [Spotify Web API](https://developer.spotify.com/documentation/web-api/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [MCP Protocol](https://modelcontextprotocol.io/)

---

**üéµ M√∫sica √© vida! Vamos fazer um servidor MCP incr√≠vel! üöÄ**
